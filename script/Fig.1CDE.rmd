---
title: "Fig.1B"
author: "Biomamba"
date: "2025-08-11"
output: openintro::lab_report
---

# 1.data Transfer  
```{r,eval=FALSE}
# marker express proportion  
ren_tub <- subset(st_rna,
                  idents = c(  "PTC" ,   "DLH" ,   "ALH"   , "DCT"  ,  "CD-PC" , "CD-IC" ))
ren_tub <- var2umap(ren_tub)

library(Seurat)
library(SeuratDisk)
SaveH5Seurat(st_rna, filename = "st_rna_8_sample.h5Seurat")

if(!require(MuDataSeurat))remotes::install_github("zqfang/MuDataSeurat", force = T)
MuDataSeurat::WriteH5AD(st_rna, "st_rna_8_sample.h5ad", assay="RNA")

joined_st <- JoinLayers(st_rna)
MuDataSeurat::WriteH5AD( JoinLayers(st_rna), "joined_st_rna_8_sample.h5ad", assay="RNA")
 
saveRDS(joined_st ,'joined_st.rds')
```
  
  
# 2.marker caculate
```{r,eval=FALSE}
stromal.markers <- FindAllMarkers(stromal, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25) 
#寻找每一个分类群与其他所有细胞之间的标记基因,并只显示positive结果
library(dplyr)
top10gene <- stromal.markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC) 

pdf(file = 'top10marker.pdf',width = 15,height = 6.5)
VlnPlot(stromal, features = unique(top10gene$gene),stack = T)
dev.off()


top3gene <- stromal.markers %>% group_by(cluster) %>% top_n(n = 3, wt = avg_log2FC) 

pdf(file = 'stromal_top3marker.pdf',width = 7,height = 4)
VlnPlot(stromal, features = unique(top3gene$gene),stack = T)
dev.off()

library(ggthemes)
pdf(file = 'stromal_top10.dot_plot.pdf',width = 15,height = 8)
DotPlot(st_rna,features =unique( top10gene$gene))+
  theme( axis.text.x.bottom = element_text(angle = 45,hjust = 1,vjust = 1))
dev.off()

ICs <- subset(st_rna,idents = c('T Cell','Mac','B Cell','Neu'))
ICs <- var2umap(ICs)

ICs.markers <- FindAllMarkers(ICs, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25) 
IC_top10gene <- ICs.markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC) 

pdf(file = 'ICs_top10marker.pdf',width = 15,height = 6.5)
VlnPlot(ICs, features = unique(IC_top10gene$gene),stack = T)
dev.off()

IC_top3gene <- ICs.markers %>% group_by(cluster) %>% top_n(n = 3, wt = avg_log2FC) 
pdf(file = 'ICs_top3marker.pdf',width = 6,height = 6.5)
VlnPlot(ICs, features = unique(IC_top3gene$gene),stack = T)
dev.off()

makecore <- function(workcore,memory){
  if(!require(Seurat))install.packages('Seurat')
  if(!require(future))install.packages('future')
  plan("multisession", workers = workcore)
  options(future.globals.maxSize= memory*1024*1024**2)
}
makecore(20,20)# 8 core,1 GB memory,

PTC_marker <- FindMarkers(st_rna,ident.1 = 'PTC',ident.2 = c('Mac', 'ALH', 'DCT', 'CD-IC', 'CD-PC', 'EnC',
                                                             'B Cell', 'SMC' ,'Podo', 'T Cell','DLH', 'Neu', 'PEC', 'NKC'))
library(dplyr)
ptc_top <- top_n(PTC_marker,n=-30,wt = p_val_adj)
VlnPlot(st_rna,features = rownames(ptc_top),stack = T)

clean_st <- subset(st_rna,idents = unique(st_rna$ten_Cell_type)[unique(st_rna$ten_Cell_type)!='NKC'])
saveRDS(clean_st,'clean_st.rds')




PTC_marker <- FindMarkers(st_rna,ident.1 = 'PTC',ident.2 = c('Mac', 'ALH', 'DCT', 'CD-IC', 'CD-PC', 'EnC',
                                               'B Cell', 'SMC' ,'Podo', 'T Cell','DLH', 'Neu', 'PEC', 'NKC'))
library(dplyr)
PTC_marker <- filter(PTC_marker,avg_log2FC > 0)
ptc_top <- top_n(PTC_marker,n=-30,wt = p_val_adj)
VlnPlot(st_rna,features = rownames(ptc_top),stack = T)

top10_ptc <- top_n(PTC_marker,wt=p_val ,n = -10)
VlnPlot(st_rna,features = rownames(top10_ptc),pt.size = 0)

DotPlot(st_rna,features =rownames(top10_ptc)[1:10])
# In kidney single-cell data, the cell type that specifically expresses genes Acsm2, Rida, Sord, Inmt, Cyp2j5, Pdzk1, Fbp1, and Chpt1 is renal tubular epithelial cells (particularly proximal tubule cells).

# Some of these genes have been shown by research to be highly expressed in kidney proximal tubule cells:

# Acsm2 (Acyl-CoA synthetase medium-chain family member 2): Commonly found in proximal tubule cells.
# Cyp2j5 (Cytochrome P450 family 2 subfamily J member 5): Predominantly expressed in kidney proximal tubule cells.
# Pdzk1 (PDZ domain containing 1): Expressed in kidney proximal tubule cells and involved in the regulation of renal tubular function.
# Fbp1 (Fructose-1,6-bisphosphatase 1): Expressed in kidney proximal tubules, it is a key enzyme in the gluconeogenesis process.

# The expression patterns of these genes indicate their involvement in the metabolism and functional regulation of renal tubular cells.
# Therefore, the cell type expressing these genes is most likely proximal tubule cells, which play important roles in the kidney, responsible for substance absorption and metabolism.
```




# 3.Visualization  
```{r,eval=FALSE}
library(ggplot2)
st_rna$ten_Cell_type <- factor(st_rna$ten_Cell_type,
                               levels = cell_order)
Idents(st_rna) <- 'ten_Cell_type'
st_gv_mk <- c('Acsm2','Pdzk1','Fbp1','Cyp2j5',# PTC
              'Aqp1','Cryab','S100a6','Psca',# DLH
              'Slc12a1','Umod',# ALH
              'Slc12a3','Pvalb', # DCT
              'Aqp2','Hsd11b2','Fxyd4',# CD-PC
              'Atp6v1g3','Slc4a9',# CD-IC
              'Ly6c1','Igfbp3','Flt1',# EnC
              'Akap12','Cp',# PEC
              'Thsd7a','Ptpro','Synpo',# Podo
              'Acta2','Myl9','Tpm2',# SMC
              'Cd3g',# T Cell
              'C1qb','C1qc',# Mac
              'Ly6d','Ighm','Cd79b',# B Cell
              'S100a9','Csf3r'# ,'Retnlg'# Neu
              
) 


DotPlot(st_rna,features = st_gv_mk,scale.by = 'size')+ 
  scale_color_gradientn(colors = one_hundred_colors)+
  theme( axis.text.x.bottom = element_text(angle = 45,hjust = 1,vjust = 1))
```



```{r,eval=FALSE}
clean_st <- subset(st_rna,
                   idents = unique(st_rna$ten_Cell_type)[!c(unique(st_rna$ten_Cell_type)   %in% c('NKC','MC'))]
                   )
# clean_st <- st_rna[,!c(st_rna$ten_Cell_type   %in% c('NKC','MC'))]

clean_cell_order = c('PTC', 'DLH','ALH','DCT','CD-PC','CD-IC',
               'EnC','PEC','Podo','SMC',
               'T Cell','Mac','B Cell','Neu')
clean_st$ten_Cell_type <- factor(clean_st$ten_Cell_type,
                                 levels = clean_cell_order) 
Idents(clean_st) <- 'ten_Cell_type'
DotPlot(clean_st,features = st_gv_mk,scale.by = 'size')+ 
  scale_color_gradientn(colors = one_hundred_colors)+
  theme( axis.text.x.bottom = element_text(angle = 45,hjust = 1,vjust = 1))
```
![](Figure 1CDE.jpg)    
  

```{r,eval=FALSE}
ggsave(filename = '../output/03.in_Seurat/clean_mk.dotplot.pdf',
       width = 10,height = 4)



VlnPlot(clean_st,features = st_gv_mk,stack = T)+
  theme( axis.text.x.bottom = element_text(angle = 45,hjust = 1,vjust = 1))
ggsave(filename = '../output/03.in_Seurat/clean_mk.vlnplot.pdf',
       width = 10,height = 4)

saveRDS(clean_st,'../output/03.in_Seurat/eight_sample_clean_st.rds')
```





